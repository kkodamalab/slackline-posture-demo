<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Slackline Posture Demo (MP Pose)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    margin: 0;
    background: #111;
    color: #fff;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  #videoArea {
    position: relative;
    flex: 1 1 auto;
    width: 100%;
    background: #000;
  }
  video, canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
  }
  #info {
    flex: 0 0 auto;
    padding: 10px;
    font-size: 16px;
    background: #222;
    line-height: 1.4;
    white-space: pre-line;
  }
</style>
</head>
<body>

<div id="videoArea">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>
<div id="info">Loading…</div>

<!-- バージョンを公式サンプルに揃える -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.3/pose.js"></script>

<script>
console.log("window.Pose =", window.Pose); // デバッグ用

const video  = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx    = canvas.getContext("2d");
const info   = document.getElementById("info");

function setupCamera() {
  return navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "user",
      width:  { ideal: 1280 },
      height: { ideal: 720 },
      aspectRatio: { ideal: 16/9 }
    },
    audio: false
  }).then(stream => {
    video.srcObject = stream;
    return new Promise(resolve => {
      video.onloadedmetadata = () => resolve();
    });
  });
}

function onResults(results) {
  if (!results.image) return;

  if (canvas.width !== results.image.width || canvas.height !== results.image.height) {
    canvas.width  = results.image.width;
    canvas.height = results.image.height;
  }

  ctx.save();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
  ctx.restore();

  const midX = canvas.width / 2;
  ctx.strokeStyle = "yellow";
  ctx.lineWidth   = 3;
  ctx.beginPath();
  ctx.moveTo(midX, 0);
  ctx.lineTo(midX, canvas.height);
  ctx.stroke();

  if (!results.poseLandmarks || results.poseLandmarks.length === 0) {
    info.textContent = "Detecting…（全身が入るよう後ろに下がってください）";
    return;
  }

  const lm = results.poseLandmarks;
  const avg = (a, b) => ({
    x: (a.x + b.x) / 2,
    y: (a.y + b.y) / 2
  });

  const s = avg(lm[11], lm[12]);  // 肩
  const h = avg(lm[23], lm[24]);  // 腰

  s.x *= canvas.width;  s.y *= canvas.height;
  h.x *= canvas.width;  h.y *= canvas.height;

  ctx.strokeStyle = "cyan";
  ctx.lineWidth   = 4;
  ctx.beginPath();
  ctx.moveTo(s.x, s.y);
  ctx.lineTo(h.x, h.y);
  ctx.stroke();

  const vx = h.x - s.x;
  const vy = h.y - s.y;
  const len = Math.hypot(vx, vy) || 1;
  const nx = vx / len;
  const ny = vy / len;

  let deg = Math.acos(Math.max(-1, Math.min(1, -ny))) * 180 / Math.PI;
  if (nx > 0) deg = +deg; else deg = -deg;

  const direction = (deg > 0) ? "右" : "左";
  const deviationDeg = Math.abs(deg).toFixed(1);

  info.textContent =
    `Pose detected.\n体軸傾き: ${direction}に ${deviationDeg}°\n理想姿勢は垂直です。傾きを 0° に近づけてください。`;
}

async function main() {
  try {
    await setupCamera();

    // ★ ここが重要：グローバル名は Pose.Pose（0.3 系の仕様）
    if (!window.Pose || !window.Pose.Pose) {
      throw new Error("Pose ライブラリの読み込みに失敗しました。window.Pose.Pose が未定義です。");
    }

    const pose = new window.Pose.Pose({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.3/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(onResults);

    const camera = new window.Camera(video, {
      onFrame: async () => {
        await pose.send({ image: video });
      },
      width: 1280,
      height: 720
    });

    camera.start();
    info.textContent = "Camera started. 全身が映る位置に下がってください。";
  } catch (e) {
    console.error(e);
    info.textContent = "Error: " + (e && e.message ? e.message : e);
  }
}

main();
</script>

</body>
</html>
